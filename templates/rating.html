{% extends "base.html" %}
{% block title %}–†–µ–π—Ç–∏–Ω–≥{% endblock %}

{% block content %}
<div class="container mt-4 rating-wrapper" style="max-width: 900px;">
    <h2 class="mb-3 text-center">–†–µ–π—Ç–∏–Ω–≥ —É—á–µ–Ω–∏–∫–æ–≤</h2>

    {% if rating|length == 0 %}
        <p>–ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ —Ä–µ—à–∏–ª üôÇ</p>
    {% else %}

        <!-- –¢–∞–±–ª–∏—á–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞ -->
        <table class="table mt-3 rating-table">
            <thead>
                <tr>
                    <th style="width: 70px;">–ú–µ—Å—Ç–æ</th>
                    <th>–ò–º—è</th>
                    <th style="width: 160px;">–†–µ—à–µ–Ω–æ –∑–∞–¥–∞—á</th>
                </tr>
            </thead>
            <tbody>
                {% for row in rating %}
                    {% set place = loop.index %}
                    {% if place == 1 %}
                        {% set row_class = "rating-first" %}
                    {% elif place == 2 %}
                        {% set row_class = "rating-second" %}
                    {% elif place == 3 %}
                        {% set row_class = "rating-third" %}
                    {% else %}
                        {% set row_class = "" %}
                    {% endif %}

                    <tr class="{{ row_class }}">
                        <td class="align-middle">
                            <div class="d-flex align-items-center">
                                {% if place == 1 %}
                                    <span class="crown" title="1 –º–µ—Å—Ç–æ">üëë</span>
                                {% endif %}
                                <span class="place-number">{{ place }}</span>
                            </div>
                        </td>
                        <td class="align-middle">
                            <strong>{{ row.username }}</strong>
                        </td>
                        <td class="align-middle">
                            <span class="badge solved-badge">
                                {{ row.solved }}
                            </span>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- –ë–ª–æ–∫ —Å –≥—Ä–∞—Ñ–∏–∫–æ–º -->
        <div class="mt-4 rating-chart-card">
            <h5 class="mb-3 text-center">–ò–Ω—Ñ–æ–≥—Ä–∞—Ñ–∏–∫–∞: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ—à—ë–Ω–Ω—ã—Ö –∑–∞–¥–∞—á</h5>

            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –≤—ã—Å–æ—Ç–æ–π –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π —à–∏—Ä–∏–Ω–æ–π -->
            <div class="chart-container">
                <canvas id="ratingChart"></canvas>
            </div>
        </div>

    {% endif %}
</div>

<style>
/* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ */
.rating-wrapper {
    backdrop-filter: blur(4px);
}

.rating-table {
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 10px 25px rgba(15, 23, 42, 0.35);
    background: radial-gradient(circle at top left, rgba(56,189,248,0.12), rgba(15,23,42,1));
    color: #e5e7eb;
}

.rating-table thead {
    background: rgba(15,23,42,0.95);
    border-bottom: 1px solid rgba(148, 163, 184, 0.4);
}

.rating-table thead th {
    border: none;
}

.rating-table tbody tr {
    border-color: rgba(30, 64, 175, 0.4);
}

/* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –º–µ—Å—Ç */
.rating-first {
    background: linear-gradient(90deg, rgba(250, 204, 21, 0.20), rgba(251, 191, 36, 0.05));
}

.rating-second {
    background: linear-gradient(90deg, rgba(148, 163, 184, 0.25), rgba(51, 65, 85, 0.1));
}

.rating-third {
    background: linear-gradient(90deg, rgba(248, 113, 113, 0.25), rgba(127, 29, 29, 0.08));
}

.rating-first td,
.rating-second td,
.rating-third td {
    border-color: transparent;
}

/* –ö–æ—Ä–æ–Ω–∞ –∏ –º–µ—Å—Ç–æ */
.crown {
    font-size: 1.4rem;
    margin-right: 6px;
    filter: drop-shadow(0 0 6px rgba(250, 204, 21, 0.9));
}

.place-number {
    font-weight: 700;
}

/* –ë–µ–π–¥–∂ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–¥–∞—á */
.solved-badge {
    font-size: 0.95rem;
    padding: 6px 14px;
    border-radius: 999px;
    background: radial-gradient(circle at top left, #22c55e, #16a34a);
    color: #f9fafb;
}

/* –ö–∞—Ä—Ç–æ—á–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞ */
.rating-chart-card {
    padding: 18px 22px 26px;
    border-radius: 18px;
    background: radial-gradient(circle at top right, rgba(59,130,246,0.28), rgba(15,23,42,1));
    box-shadow: 0 10px 25px rgba(15, 23, 42, 0.5);
}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≥—Ä–∞—Ñ–∏–∫–∞: —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –∏ –∞–¥–µ–∫–≤–∞—Ç–Ω–∞—è —à–∏—Ä–∏–Ω–∞ */
.chart-container {
    position: relative;
    max-width: 700px;   /* —á—Ç–æ–±—ã –≥—Ä–∞—Ñ–∏–∫ –Ω–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–ª—Å—è –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É —ç–∫—Ä–∞–Ω–∞ */
    height: 260px;      /* —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞, —á—Ç–æ–±—ã "–Ω–µ –ª–µ–∑ –≤–≤–µ—Ä—Ö" */
    margin: 0 auto;
    overflow-x: auto;   /* –µ—Å–ª–∏ –º–Ω–æ–≥–æ —É—á–µ–Ω–∏–∫–æ–≤, –ø–æ—è–≤–∏—Ç—Å—è –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–π –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª */
}

.chart-container canvas {
    width: 100% !important;
    height: 100% !important;
}
</style>
{% endblock %}

{% block extra_scripts %}
    {{ super() }}
    {% if rating|length > 0 %}
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // –ü–æ–¥–ø–∏—Å–∏
        const labels = [
            {% for row in rating %}
                "{{ row.username }}"{% if not loop.last %}, {% endif %}
            {% endfor %}
        ];

        // –î–∞–Ω–Ω—ã–µ
        const solvedData = [
            {% for row in rating %}
                {{ row.solved }}{% if not loop.last %}, {% endif %}
            {% endfor %}
        ];

        // –¶–≤–µ—Ç–∞ –¥–ª—è —Å—Ç–æ–ª–±–∏–∫–æ–≤ (—Ç–æ–ø-3 –≤—ã–¥–µ–ª—è–µ–º)
        const barColors = [
            {% for row in rating %}
                {% if loop.index == 1 %}
                    'rgba(250, 204, 21, 0.95)'   /* –∑–æ–ª–æ—Ç–æ */
                {% elif loop.index == 2 %}
                    'rgba(148, 163, 184, 0.95)'  /* —Å–µ—Ä–µ–±—Ä–æ */
                {% elif loop.index == 3 %}
                    'rgba(248, 113, 113, 0.95)'  /* –±—Ä–æ–Ω–∑–∞ */
                {% else %}
                    'rgba(59, 130, 246, 0.85)'   /* –æ–±—ã—á–Ω—ã–π —Å–∏–Ω–∏–π */
                {% endif %}
                {% if not loop.last %}, {% endif %}
            {% endfor %}
        ];

        const borderColors = [
            {% for row in rating %}
                {% if loop.index == 1 %}
                    'rgba(161, 98, 7, 1)'
                {% elif loop.index == 2 %}
                    'rgba(55, 65, 81, 1)'
                {% elif loop.index == 3 %}
                    'rgba(127, 29, 29, 1)'
                {% else %}
                    'rgba(30, 64, 175, 1)'
                {% endif %}
                {% if not loop.last %}, {% endif %}
            {% endfor %}
        ];

        const ctx = document.getElementById('ratingChart').getContext('2d');

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    data: solvedData,
                    backgroundColor: barColors,
                    borderColor: borderColors,
                    borderWidth: 2,
                    borderRadius: 8,
                    maxBarThickness: 26    // –±—ã–ª–æ 46, –¥–µ–ª–∞–µ–º —Å—Ç–æ–ª–±–∏–∫–∏ –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,  // –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ–º—Å—è –ø–æ–¥ height –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(ctx) {
                                return ctx.parsed.y + ' –∑–∞–¥–∞—á(–∏)';
                            }
                        }
                    },
                    title: {
                        display: false
                    }
                },
                layout: {
                    padding: {
                        top: 10,
                        right: 10,
                        left: 10,
                        bottom: 10
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            color: '#e5e7eb',
                            maxRotation: 40,
                            minRotation: 0,
                            font: {
                                size: 12
                            }
                        },
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0,
                            color: '#9ca3af'
                        },
                        grid: {
                            color: 'rgba(55, 65, 81, 0.5)'
                        }
                    }
                }
            }
        });
    </script>
    {% endif %}
{% endblock %}
